on:
  push:
    branches:
      - master

jobs:
  matrix:
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Generate build matrix
        uses: reitermarkus/rust-build-matrix@main
        id: matrix

  build:
    runs-on: ${{ matrix.os }}
    needs: matrix
    strategy:
      matrix:
        include: ${{ fromJSON(needs.matrix.outputs.matrix) }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - run: |
          rustup target add "${target}"
          cargo build --release --target "${target}"
          tar -czf "sbp-${target}.tar.gz" -C "target/${target}/release" sbp

        env:
          target: ${{ matrix.target }}

      - uses: actions/upload-artifact@v4
        with:
          name: "sbp-${{env.target}}.tar.gz"
          path: "sbp-${{env.target}}.tar.gz"
          retention-days: 1

        env:
          target: ${{ matrix.target }}

  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Release
        uses: v1olen/version-release-github-action@main
        with:
          download-pattern: "sbp-*.tar.gz"
          release-version: "0.4.3"
          create-latest: "true"
